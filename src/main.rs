#![feature(io)]

use std::env;
use std::char;
use std::io::{self, Write, Read};

macro_rules! stderr(
    ($($argument:tt)*) => { {
        writeln!(&mut io::stderr(), $($argument)*)
            .expect("Failed to printing to stderr");
    } }
);

fn main() {
    let mut wide_spacing    = false; // (behave like `cat`
    let mut wide_characters = false; // by default)

    for argument in env::args().skip(1){
        if      argument == "-s" || argument == "--spacing"{
            wide_spacing = true;
        }
        else if argument == "-w" || argument == "--wide-characters"{
            wide_characters = true;
        }
        else if argument == "-h" || argument == "--help"{
            println!(concat!("Usage: {} [arguments] < infile > outfile\n",
                             "\t-h, --help: this text ( ͡° ͜ʖ ͡°)\n",
                             "\t-v, --version: version information\n",
                             "\t-s, --spacing: spaces are inserted between characters\n",
                             "\t-w, --wide-characters: where possible, characters are converted to Unicode wide character forms\n",
                             "By default this program behaves like `cat`."),
                     env::args().nth(0)
                      .expect("No first argument was supplied to the program"));
            return;
        }
        else if argument == "-v" || argument == "--version"{
            println!("autovaporwave version {}", env!("CARGO_PKG_VERSION"));
            return;
        }
        else{
            stderr!("Unknown argument: {}", argument);
            return;
        }
    }

    for input in io::stdin().chars(){
        match input{
            Ok(input_char) => {
                if wide_characters{
                    let input_codepoint = input_char as u32;
                    // if in the region of ASCII covered by Unicode wide characters
                    if input_codepoint >= '!' as u32 && input_codepoint <= '~' as u32{
                        // then print out the wide char version
                        // by shifting it from the codepoint range 0x00000021-0x0000007E
                        // to the range 0x0000FF01-0x0000FF7E (by adding the difference, 0xFEE0)
                        let output_widechar = char::from_u32(input_codepoint + 0xFEE0)
                            .expect("Somehow did not generate a valid codepoint, this is probably a bug");
                        print!("{}", output_widechar);
                    }
                    else{
                        // otherwise, just pass it through unmodified
                        print!("{}",input_char);
                    }
                }
                else{
                    print!("{}", input_char);
                }

                if wide_spacing{
                    print!("{}", ' '); // will print a useless extra space at the end
                }
            },
            Err(e) => stderr!("Error reading character: {:?}", e)
        };
    }
}

/*
,,,,,,,,.....:+'',::::::;;:,::;',,:::..,,,,.,......,,,,,,,,,,,,
,,,,,,.....,,.;++,:#;.,`,:;:.,,..`:'#;.;;,,......,,,,,,,,,,,,,,
,,,,,....,'`.;:#+@@#``,+..,:',,`.,;#@#+:,':,,,,,,.,,,,,,,,,,,,,
,,,,,,..,;. `#@@@`+,``,;;:`,.`,;+###';;';.;:.::,,.,,,,,,,,,,,,,
,,,,,...:;.@@@@@@@+;  `,+:.,;+@+;@#+:',#;#,;,.;:,..,.,,,,,,,,,,
,,,,,...#;,@@@@@@#@@.  ,';;+'+:.:';:`;::@@+ +..::,.,,.,,,,,,,,,
,,,,....;+;`   `@@@@# `:',.:',,:``   ,;:@@#: : `,:,,...,,,,,,,,
,,,,...`,#:`   :@@@@@@:'',.;,,:.,`. ; +@@@@#',   :;,.....,,,,,,
,,,,...`,@+:''+:` .@@+,  ```;#;,`;##;++  '@@@@###'':,....,,,,,,
,,,...``+@#@@,`    @',````.'#+',#. ; `@,  ;@#,:'@,#':,...,.,,,,
,,...``,@@@,....``#',:,`, `@@#'+'.'###:@.  ##; ,   ;',,...,,,,,
,...```+@@@++;+;,@@:''';'`.@+#;'.  #@'#;@  +#:`:`  ;':,,..,,,,,
,...`'#+#@''+++#@@;,''##' `@+:+:`:@@@@@#:'. @+: +. :#;,,....,,,
..``,@#+#'';,#@@@;,;;+',, .+:'+:`#+.,'@@'.` @@+@`'  @':,,...,,,
..``#@++''+:,+;,,:,:,..':``;+';`:+ .  `@@:.`,@#'`::`:';;,,.,...
.```@@##'+':..:,,,,;'++##;:,,:;:;:;':,` @# : @@;,     :+::,,...
.``;@@#@#+':`,:;:::'#@@@#,,,.::.,.;'.'#.`@';`'@@#:+.    ,;:,,,.
`` ##+#+#''.`,##.:;''::..`;:,.`      `;;.:@,. @@@;.`    `,;::,,
`.:';:.';':.`+@@,:,:::.`..``.``.``      '+@#`  :@@#+#:,`  .:;:,
`+@;.,,+';,,.@@#,..,;,.,,....``,,..```   .+@#``    `;+@+..`:,;:
`+;``,;':,,..+@:.::.,,:..,:::.,:;;:,,,.   .#@@; ,;;'@@@@;  :,,'
#'``,:++::,.,'+..,;,,,,,:::::,.;:,....```  `@@@@@@'+@,#@@``:,,:
@',:,.#+::..:;+,;;;::ａｅｓｔｈｅｔｉｃ,,,.    ;#+::: ;. @@. :;.:
@:+:.:#+;,,'';;,:;;::;;:,,,....:,,.......`    `:;+', '  @. `...
@,;`.:'',,:'+':;;;::::::,.,,.``,,....` `````   .;'#,`#, `.,.`,`
@#:`:+';,,:;:`.':,,:::::,...```,:.```..````.`   ;@@'`#:  +:,.,.
;@'``;+'`;':,.,;;,,,::,,...````,,,.`..,,.`````   @#+.`#` '',,:#
`++@,`',:@,.``.',,,,:,.,:;;,.``,,...,;;:,...`    @@+, #. `.,..@
`,'+,`'.:. `. :'.,,,.,::'+#':``..` ..::;'';,:.   '@#, @;``  .`@
`.,++`:'@#;;,:@;.,.::,'#####',..`  `,++;#@#'.:    @@'.'+,`  ` #
`..@#',#++#+@@@:.,::;:.`,@@#+':.   .+#:;,`.++;:`  @@': #+,  `:#
``.+'';#@'#`,@@..::;'@@@++@@+;`,`  :@:,..`  .+:.  @@+:.`##. :##
``.;++'+,::`;@#``;;+'`  .#@@#,,,   :':,,:,`  ::;  '@#;,,`   `#'
``.@'#+@:':,@@@`.;++,`   ;@@@:,,`  .,,,,,..   .;  :@@+`,.'+; #:
```###@@@+,#@@+`.+'':.`  :###',``   `,::'';.```;` `@@#@@@@+;#',
```##@'@;;.#@@'.,;;;;:;`.;+#+;:` `   .,::;;,.` .`  @@+::;+;:;:,
``.#@;'#;@ '@#':'#;:;';:;#+';;,```   ```...`````   @@'.`.+:,`;#
``.@+'+#`@.'#++,'';;'':::;;::;,  ```````````````   @@'....:;`;@
``.@#'+'.@;+##'`,::,;,,.::;::;,`,. `````.```.````  '@;..,,';`'@
``'+++;;;@@''@:`....`..,:;:,:'. `.```.....`````.`   @':,:.,,::@
``'::';:.@@,+@``.....,,,:;:,:;,  `````.,,...`````   @+,,.,,.`:@
`,';,'# `@@:+@``,,,,,,,,,::,,''   .`  .,...``````   @#;.,,...`@
`.+;:+#  +@;#@  .,,,,,.,,;:,'#+,   .` .:,..```````  +': ,...  @
`.#+;#,` ;@;+@``.,:::,,::;;'#@@#` `#' .::.````````  :# .,:..  @
`.#;;#,` ,@'+@ `.::::,,::''#@@@@:` ;# `::,.``````.` :#, ,:...`@
`.,:':```;@;#@ `,::::,,,,;''##:;;;  , .,,,,.`.....  ,+', .,.`,@
`..:',`,:'#:@@'`,,::,:,...:'',. `.  ``..,,,....``````+#+`  ` +@
...:','',.+@@@# .,:::,,....::.   ,`    `............ ,+';:   +@
...'@:,:`+@+@@+`.,::::,,...,,;:``',     ``````.```..  ,;,:.  @@
....#,,.`::'@#;`.,::;:...,,:::+;'+#;    ``....``...`   .`.,.;@@
..`.#:::,;+@#':``,::;:,..:;:'+##'#@@#;`  ````..```.`    ,;+:@@@
..`.@@;+##@#+::..,::;:,..,:,;::+'##@+@@,,.```..`.```    @@   @@
...,#@##+'##'::.`,,::;,.,,'+;;+#', `;'@@;.`````````  :;:#,   +@
....#@+'::;+#@@.`.:::::::`,##,       ..;;,````````  ,@@@:`   +@
....##';::::;#@,..:::::,,``+:,..`.`,``  ,..```.`.`  @@@;  ` `@@
..`.'##+;'':,#@,..,::':,,,:;;'';'++',`  ``.````.``  @@@, .  .@@
...`,###@@@+;+@,`,,::;:,:,:;;;;,,::',` ````````..   @@@# `  :@@
,....+@@@@+:,'@:`,::,::::,,:;,,````.```````````.`  `@#'#.   @@#
,....;##@;:::+@,.,,:,::;:,,,,.,..`.`.`````````..`  @@+:',   ###
,.....:##':,;@@.,.,:::::::,,:::..`...  ` ``````.   @#,;`.  `##@
,.....,'#+;,,@@,,.,:::::::,::::....,.   ``````.`  .@'.;,`  :+#@
,,,....,'+'';@+.,,,:,:::;;:::::...,:,`  .`.....`  @@.`:;`  ;++@
,,,,....:##++#:.,,,,,,;;:;::;:,,,..,,.``````...`  @#`.:'   +''@
,,,,.....:#@''.,.::,,,::;::;;;:,,,..,.` ``.`...` `@+..:;  ;+;'@
,,,,,,....'@+:.,.::,,:::;;:;''':,:,:::........,. @@;.,::,.@+:;@
,,,,,,....,@#:.,,,::,,:,::::;'';'';'''':,,,,::;, @@:,,::`+#;::'
,,,,,,.....;#;,,,,::::,:::::;;'''';';';:,:::;':  @@:,.`` #',,:'
,,,,,,.....,';:,,,:::::::,:::;''+#+''';;;'''+:   @#,.,  '#;,,:+
,,,,,,,.....::,:::::;::;;;,:,;:';''++++#+++',`   @#:., :@+:..:+
,,,,,,,,...,,,:::::;::::;;:;;;;;;''++###+;.`    `@#;;:,@#',..:#
,,,,,,,,,..,,,::;:;'';::;;;''+##+#+###;:.`      .@+,:.,'+;.`.:@
,,,,,,,,,..,,,:::;;;;':;';;:::;:,...`      ``   `@+.`. '+;...;@
,,,,,,,,,..,::::;::::,:::,,,,,..`        `````  +@+'., @+:...;@
,,,,,,,,,,.,::::,,,:,.....,,..`.     ``````..`  @@'.``##;,.``;@
,,,,,,,,,.,,::;:,:,:,........,,,..``.`.`````.   @#,   @+:,.`.:#
,,,,,,,,,..,::;:::,,::,`.,,..,,..``....``..``   @+` `++':,.`.;#
,,,,,,,....;:;::,:,,,....,:..,,..````.```..``  ;@@@#@#';,,.`.;+
*/
